name: Build and Release
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  prepare_repository:
    name: 游닍 Preparar reposit칩rio
    runs-on: ubuntu-latest
    outputs:
      lowercase_repo: ${{ steps.repo_name.outputs.lowercase_repo }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set lowercase repository name
        id: repo_name
        run: |
          LOWERCASE_REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "lowercase_repo=$LOWERCASE_REPO" >> $GITHUB_OUTPUT

      - name: Update package version, generate and push README
        run: |
          echo "::group::Atualizando arquivos e commitando na main"
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          LOWERCASE_REPO="ghcr.io/${{ steps.repo_name.outputs.lowercase_repo }}"

          npm version $CURRENT_TAG --no-git-tag-version || echo "Vers칚o j치 est치 configurada."

          rm -f README.md docker-compose.yml

          sed -e "s|{{repository}}|${{ github.repository }}|g" \
            README.template.md > README.md

          sed -e "s|{{lowercase_repo}}|${LOWERCASE_REPO}|g" \
              -e "s|{{repository}}|${{ github.event.repository.name }}|g" \
              docker-compose.yml.template > docker-compose.yml

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md docker-compose.yml package.json
          git commit -m "chore(skip ci): Atualizado README.md e docker-compose.yml" || echo "Nenhuma mudan칞a detectada."
          git push origin HEAD:main
          echo "::endgroup::"

  build_docker:
    name: 游냡 Build & Push Docker
    runs-on: ubuntu-latest
    needs: prepare_repository
    outputs:
      image_tags: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ needs.prepare_repository.outputs.lowercase_repo }}
          tags: |
            type=raw,value=latest
            type=raw,value=${{ github.ref_name }}

      - name: Debug Docker metadata
        run: |
          echo "META TAGS: ${{ steps.meta.outputs.tags }}"
          echo "META LABELS: ${{ steps.meta.outputs.labels }}"

      - name: Set created timestamp
        id: date
        run: |
          echo "created=$(date --utc +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: |
            ${{ steps.meta.outputs.labels }}
            org.opencontainers.image.title=${{ github.event.repository.name }}
            org.opencontainers.image.description=${{ github.event.repository.description }}
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.version=${{ github.ref_name }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.date.outputs.created }}
            org.opencontainers.image.authors=${{ github.actor }}
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}#readme
            org.opencontainers.image.licenses=CC0-1.0

      # SBOM generation removed (opted out).

      - name: Install cosign (explicit)
        run: |
          COSIGN_VERSION=v2.1.0
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            BIN=cosign-linux-amd64
          elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
            BIN=cosign-linux-arm64
          else
            BIN=cosign-linux-amd64
          fi
          curl -sL "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/${BIN}" -o cosign
          chmod +x cosign
          sudo mv cosign /usr/local/bin/cosign
          cosign version || true

      - name: Sign images with cosign (keyless)
        env:
          COSIGN_EXPERIMENTAL: '1'
        run: |
          echo "cosign version: $(cosign version)"
          echo "cosign help (sign):"; cosign help sign || true
          echo "Signing images: ${{ steps.meta.outputs.tags }}"
          IFS=',' read -ra IMAGES <<< "${{ steps.meta.outputs.tags }}"
          for IMG in "${IMAGES[@]}"; do
            echo "Signing $IMG (keyless)..."
            cosign sign --keyless "$IMG" || {
              echo "Keyless signing failed for $IMG.\nPossible causes:\n - installed cosign does not support --keyless\n - OIDC is disabled for this repository/org\n - network access to fulcio/rekor is blocked\nAttempting fallback: skip signing for this image.";
            }
          done

  generate_release_notes:
    name: 游닇 Gerar notas de release
    runs-on: ubuntu-latest
    outputs:
      release_body: ${{ steps.prepare_release_body.outputs.body }}
      version: ${{ steps.get_project_information.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get commit messages
        id: get_project_information
        run: |
          echo "::group::Coletando commits"
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"

          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log $LAST_TAG..$GITHUB_SHA --oneline --pretty=format:"%h %s")
          else
            COMMITS=$(git log --oneline --pretty=format:"%h %s")
          fi

          if [ -z "$COMMITS" ]; then
            echo "Nenhuma mudan칞a significativa desde a 칰ltima release." > ./release_body.txt
          else
            echo "$COMMITS" > ./release_body.txt
          fi

          echo "version=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Prepare release body
        id: prepare_release_body
        run: |
          if [ -f release_body.txt ]; then
            # Use the multiline GITHUB_OUTPUT format to avoid errors when the body contains newlines
            echo "body<<EOF" >> $GITHUB_OUTPUT
            head -c 1900 release_body.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "body=Nenhuma nota de release dispon칤vel." >> $GITHUB_OUTPUT
          fi

  create_release:
    name: 游 Criar Release
    runs-on: ubuntu-latest
    needs: [build_docker, generate_release_notes]
    steps:
      - name: Create GitHub Release (via API)
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          RELEASE_NAME="${{ needs.generate_release_notes.outputs.version }}"
          RELEASE_BODY="${{ needs.generate_release_notes.outputs.release_body }}"

          echo "Creating release ${TAG_NAME} for repository ${GITHUB_REPOSITORY}"

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\": \"${TAG_NAME}\", \"name\": \"${RELEASE_NAME}\", \"body\": \"${RELEASE_BODY//"/\\\"}\", \"draft\": false, \"prerelease\": false}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases")

          echo "Release create response: $RESPONSE"

          UPLOAD_URL=$(python - <<'PY'
import sys, json
resp = json.load(sys.stdin)
print(resp.get('upload_url',''))
PY
<<<"$RESPONSE")

          if [ -z "$UPLOAD_URL" ]; then
            echo "Failed to obtain upload_url from release response"
            exit 1
          fi

          echo "upload_url=$UPLOAD_URL" >> $GITHUB_OUTPUT

      # SBOM download/upload steps removed.

  post_to_discord:
    name: 游댒 Notificar no Discord
    runs-on: ubuntu-latest
    needs: create_release
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Post to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.UPDATE_DISCORD_WEBHOOK }}
          RELEASE_URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
          RELEASE_TAG: ${{ github.ref_name }}
          RELEASE_AUTHOR: ${{ github.actor }}
          RELEASE_BODY: ${{ needs.generate_release_notes.outputs.release_body }}
          LOGO_URL: ${{ secrets.LOGO_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "Webhook URL n칚o definido. Pulando o envio do webhook."
            exit 0
          fi

          REPO_DESCRIPTION=$(curl -s https://api.github.com/repos/${{ github.repository }} | jq -r .description)

          EMBED_DATA='{
              "embeds": [{
              "author": {
                "name": "Github - Updates",
                "icon_url": "'"${LOGO_URL:-}"'"
              },
              "title": "[${{ github.event.repository.name }}] Nova vers칚o dispon칤vel: '"${RELEASE_TAG}"'",
              "url": "'"${RELEASE_URL}"'",
              "description": "'"${REPO_DESCRIPTION}"'",
              "fields": [{
                  "name": "O que h치 de novo?",
                  "value": "'"${RELEASE_BODY}"'"
              },
              {
                  "name": "Veja todas as mudan칞as",
                  "value": "[Veja todas as mudan칞as aqui](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }})"
              }],
              "color": 4243543,
              "footer": {
                "text": "Realizado por: '"${RELEASE_AUTHOR}"'",
                "icon_url": "'"${LOGO_URL:-}"'"
              },
              "timestamp": "'"$(date --utc +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
          }'

          curl -H "Content-Type: application/json" \
              -d "$EMBED_DATA" \
              $DISCORD_WEBHOOK_URL
